CREATE TABLE SALES
(
  SALES_ID INT COMMENT '注文番号',
  SHOP_CODE STRING COMMENT '店舗コード',
  SALES_DATE STRING COMMENT '売上日'
)
ROW FORMAT DELIMITED
  FIELDS TERMINATED BY '\t'
  LINES TERMINATED BY '\n'
;

CREATE TABLE SALES_DETAIL
(
  SALES_ID INT COMMENT '注文番号',
  DETAIL_ID INT COMMENT '明細番号',
  ITEM_CODE STRING COMMENT '商品コード',
  UNIT_PRICE INT COMMENT '単価',
  QUANTITY INT COMMENT '個数'
)
ROW FORMAT DELIMITED
  FIELDS TERMINATED BY '\t'
  LINES TERMINATED BY '\n'
;

CREATE TABLE ITEM_MASTER
(
  ITEM_CODE STRING COMMENT '商品コード',
  ITEM_NAME STRING COMMENT '商品名',
  UNIT_PRICE INT COMMENT '単価'
)
ROW FORMAT DELIMITED
  FIELDS TERMINATED BY '\t'
  LINES TERMINATED BY '\n'
;

CREATE TABLE SHOP_MASTER
(
  SHOP_CODE STRING COMMENT '店舗コード',
  REGION STRING COMMENT '地域'
)
ROW FORMAT DELIMITED
  FIELDS TERMINATED BY '\t'
  LINES TERMINATED BY '\n'
;

hive> LOAD DATA LOCAL INPATH '/home/hiveuser/hive/sales_sample/sales.tsv' INTO TABLE SALES;
hive> LOAD DATA LOCAL INPATH '/home/hiveuser/hive/sales_sample/sales_detail.tsv' INTO TABLE SALES_DETAIL;
hive> LOAD DATA LOCAL INPATH '/home/hiveuser/hive/sales_sample/itemlist.tsv' INTO TABLE ITEM_MASTER;
hive> LOAD DATA LOCAL INPATH '/home/hiveuser/hive/sales_sample/shoplist.tsv' INTO TABLE SHOP_MASTER;


SELECT S.SHOP_CODE, SUM(SD.UNIT_PRICE * SD.QUANTITY)
FROM SALES S JOIN SALES_DETAIL SD ON (S.SALES_ID = SD.SALES_ID)
WHERE S.SHOP_CODE = 'shop00088' AND S.SALES_DATE LIKE '2012-02%'
GROUP BY S.SHOP_CODE;


CREATE EXTERNAL TABLE EXPORT_SALES
(
  SHOP_CODE STRING,
  SALES_DATE STRING,
  TOTAL_PRICE STRING
)
ROW FORMAT
  DELIMITED FIELDS TERMINATED BY '\t'
  LINES TERMINATED BY '\n'
LOCATION '/user/hiveuser/export_sales'
;


INSERT OVERWRITE TABLE EXPORT_SALES
SELECT S.SHOP_CODE,S.SALES_DATE,SUM(SD.UNIT_PRICE * SD.QUANTITY)
FROM SALES S JOIN SALES_DETAIL SD ON (S.SALES_ID = SD.SALES_ID)
WHERE S.SALES_DATE LIKE '2012-02%'
GROUP BY S.SHOP_CODE, S.SALES_DATE;
